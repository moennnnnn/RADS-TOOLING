-- =======================
-- RADS TOOLING COMPLETE DATABASE SCHEMA
-- Final Consolidated Version - October 2025
-- =======================
-- Supports:
--   ✓ Premade Products + Custom Cabinets
--   ✓ Full E-commerce Flow (Cart → Checkout → Order Tracking)
--   ✓ Dual Chat System (Guest + Customer Support)
--   ✓ Order Cancellation Tracking
--   ✓ Content Management (Announcements/Banners)
--   ✓ User Activity Logs & Security
--   ✓ Password Reset System
--   ✓ Persistent Chat Clear (Customer view only)
--   ✓ Admin Read Status Tracking
-- =======================

-- ============================================================
-- PART 1: CORE USER TABLES
-- ============================================================

-- Staff users (Owner/Admin/Secretary)
CREATE TABLE IF NOT EXISTS admin_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role ENUM('Owner', 'Admin', 'Secretary') NOT NULL DEFAULT 'Secretary',
    profile_image VARCHAR(255) DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- Insert default Owner account (only if doesn't exist)
INSERT IGNORE INTO admin_users (username, password, full_name, role)
VALUES (
    'admin',
    '$2y$10$tZQpbFsqPgp1f0eCMXI6ZeM9guDbJt6631WkLtuoZcN1eKazk/W4u', -- "admin123"
    'System Owner',
    'Owner'
);

-- Customers table (with email verification)
CREATE TABLE IF NOT EXISTS customers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    profile_image VARCHAR(255) NULL,
    email_verified TINYINT(1) NOT NULL DEFAULT 0,
    verification_code VARCHAR(10) DEFAULT NULL,
    verification_expires DATETIME DEFAULT NULL,
    phone VARCHAR(20),
    address VARCHAR(255) NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_email (email),
    INDEX idx_username (username)
) ENGINE=InnoDB;

-- ============================================================
-- PART 2: PRODUCT TABLES
-- ============================================================

-- Products table (premade cabinets)
CREATE TABLE IF NOT EXISTS products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    stock INT DEFAULT 0,
    image VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_type (type),
    INDEX idx_stock (stock)
) ENGINE=InnoDB;

-- Customizable cabinet templates
CREATE TABLE IF NOT EXISTS cabinets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    base_price DECIMAL(10,2) NOT NULL,
    image VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_type (type)
) ENGINE=InnoDB;

-- Customer's saved cabinet designs
CREATE TABLE IF NOT EXISTS customizations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT NOT NULL,
    cabinet_id INT NOT NULL,
    color VARCHAR(50),
    size VARCHAR(50),
    layout VARCHAR(50),
    material VARCHAR(50),
    price_adjustment DECIMAL(10,2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (cabinet_id) REFERENCES cabinets(id) ON DELETE CASCADE,
    INDEX idx_customer_id (customer_id),
    INDEX idx_cabinet_id (cabinet_id)
) ENGINE=InnoDB;

-- ============================================================
-- PART 3: SHOPPING CART
-- ============================================================

-- Shopping cart (supports BOTH products and custom cabinets)
CREATE TABLE IF NOT EXISTS cart_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT NOT NULL,
    item_type ENUM('product', 'cabinet') NOT NULL,
    product_id INT DEFAULT NULL,
    cabinet_id INT DEFAULT NULL,
    customization_id INT DEFAULT NULL,
    quantity INT DEFAULT 1,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    FOREIGN KEY (cabinet_id) REFERENCES cabinets(id) ON DELETE CASCADE,
    FOREIGN KEY (customization_id) REFERENCES customizations(id) ON DELETE SET NULL,
    INDEX idx_customer_id (customer_id),
    INDEX idx_item_type (item_type)
) ENGINE=InnoDB;

-- ============================================================
-- PART 4: ORDERS & PAYMENTS
-- ============================================================

-- Orders table
CREATE TABLE IF NOT EXISTS orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_code VARCHAR(20) UNIQUE NOT NULL,
    customer_id INT NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    payment_status ENUM('Pending', 'Partially Paid', 'Fully Paid') DEFAULT 'Pending',
    status ENUM('Pending', 'Processing', 'Completed', 'Cancelled') DEFAULT 'Pending',
    cancelled_by ENUM('customer', 'admin') DEFAULT NULL,
    cancellation_reason TEXT DEFAULT NULL,
    cancelled_at TIMESTAMP NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    INDEX idx_customer_id (customer_id),
    INDEX idx_order_code (order_code),
    INDEX idx_status (status)
) ENGINE=InnoDB;

-- Order items
CREATE TABLE IF NOT EXISTS order_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    item_type ENUM('product', 'cabinet') NOT NULL,
    product_id INT DEFAULT NULL,
    cabinet_id INT DEFAULT NULL,
    customization_id INT DEFAULT NULL,
    quantity INT DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT,
    FOREIGN KEY (cabinet_id) REFERENCES cabinets(id) ON DELETE RESTRICT,
    FOREIGN KEY (customization_id) REFERENCES customizations(id) ON DELETE SET NULL,
    INDEX idx_order_id (order_id),
    INDEX idx_item_type (item_type)
) ENGINE=InnoDB;

-- Order status timeline
CREATE TABLE IF NOT EXISTS order_status_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    status ENUM('Pending', 'Processing', 'Completed', 'Cancelled') NOT NULL,
    changed_by INT DEFAULT NULL,
    notes TEXT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (changed_by) REFERENCES admin_users(id) ON DELETE SET NULL,
    INDEX idx_order_id (order_id),
    INDEX idx_changed_at (changed_at)
) ENGINE=InnoDB;

-- Payment records
CREATE TABLE IF NOT EXISTS payments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    amount_paid DECIMAL(10,2) NOT NULL,
    payment_method ENUM('GCash QR', 'Cash', 'Bank Transfer', 'Cheque') NOT NULL,
    qr_code VARCHAR(255),
    payment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    verified_by INT DEFAULT NULL,
    verified_at TIMESTAMP NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (verified_by) REFERENCES admin_users(id) ON DELETE SET NULL,
    INDEX idx_order_id (order_id),
    INDEX idx_payment_date (payment_date)
) ENGINE=InnoDB;

-- ============================================================
-- PART 5: FEEDBACK & MESSAGING
-- ============================================================

-- Feedback table
CREATE TABLE IF NOT EXISTS feedback (
    id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT NOT NULL,
    order_id INT,
    rating INT CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    INDEX idx_customer_id (customer_id),
    INDEX idx_order_id (order_id)
) ENGINE=InnoDB;

-- Chat messages (logged-in customer ↔ admin communication)
CREATE TABLE IF NOT EXISTS messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sender_type ENUM('customer', 'admin') NOT NULL,
    sender_id INT NOT NULL,
    receiver_type ENUM('customer', 'admin') NOT NULL,
    receiver_id INT NOT NULL,
    message TEXT NOT NULL,
    read_status TINYINT(1) DEFAULT 0,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_sender (sender_type, sender_id),
    INDEX idx_receiver (receiver_type, receiver_id),
    INDEX idx_sent_at (sent_at)
) ENGINE=InnoDB;

-- ============================================================
-- PART 6: GUEST CHAT SUPPORT SYSTEM
-- ============================================================

-- Drop old chat tables if they exist
DROP TABLE IF EXISTS rt_chat_messages;
DROP TABLE IF EXISTS rt_chat_threads;
DROP TABLE IF EXISTS rt_faqs;
DROP TABLE IF EXISTS chat_messages;
DROP TABLE IF EXISTS chat_threads;
DROP TABLE IF EXISTS chat_faqs;

-- FAQs database (for chatbot auto-responses)
CREATE TABLE rt_faqs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    question VARCHAR(255) NOT NULL,
    answer TEXT NOT NULL,
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_active (is_active),
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Chat threads (customer chat sessions)
CREATE TABLE rt_chat_threads (
    id INT AUTO_INCREMENT PRIMARY KEY,
    thread_code VARCHAR(32) UNIQUE NOT NULL,
    customer_id INT DEFAULT NULL,
    customer_name VARCHAR(120) NULL,
    customer_email VARCHAR(160) NULL,
    customer_phone VARCHAR(64) NULL,
    status ENUM('open','closed') DEFAULT 'open',
    last_message_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    admin_last_read DATETIME DEFAULT NULL,
    customer_cleared_at DATETIME DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE SET NULL,
    INDEX idx_code (thread_code),
    INDEX idx_customer_id (customer_id),
    INDEX idx_last_message (last_message_at),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Chat messages (messages in threads)
CREATE TABLE rt_chat_messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    thread_id INT NOT NULL,
    sender_type ENUM('customer','admin','bot') NOT NULL,
    sender_id INT NULL,
    body TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_thread (thread_id),
    INDEX idx_sender (sender_type),
    INDEX idx_created (created_at),
    CONSTRAINT fk_rt_msg_thread 
        FOREIGN KEY (thread_id) 
        REFERENCES rt_chat_threads(id) 
        ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Seed Sample FAQs
INSERT INTO rt_faqs (question, answer, is_active) VALUES
('operating hours', 'We operate from 8am-5pm', 1),
('operating hours?', 'We operate from 8am-5pm', 1),
('What are your operating hours?', 'We operate from 8am-5pm', 1),
('hours', 'We operate from 8am-5pm', 1),
('delivery', 'Yes, we deliver within Cavite and nearby cities. Fees vary by location.', 1),
('deliver', 'Yes, we deliver within Cavite and nearby cities. Fees vary by location.', 1),
('do you deliver', 'Yes, we deliver within Cavite and nearby cities. Fees vary by location.', 1),
('do you deliver?', 'Yes, we deliver within Cavite and nearby cities. Fees vary by location.', 1),
('customize', 'Yes! Share your preferred dimensions and color; we will confirm feasibility and pricing.', 1),
('customization', 'Yes! Share your preferred dimensions and color; we will confirm feasibility and pricing.', 1),
('Can I customize size/color?', 'Yes! Share your preferred dimensions and color; we will confirm feasibility and pricing.', 1),
('lead time', 'Typical build time is 7–14 days depending on customization.', 1),
('lead times', 'Typical build time is 7–14 days depending on customization.', 1),
('What are your lead times?', 'Typical build time is 7–14 days depending on customization.', 1),
('location', 'We are located at Green Breeze, Piela, Dasmarinas Cavite.', 1),
('located', 'We are located at Green Breeze, Piela, Dasmarinas Cavite.', 1),
('Where are you located?', 'We are located at Green Breeze, Piela, Dasmarinas Cavite.', 1);

-- ============================================================
-- PART 7: CONTENT MANAGEMENT
-- ============================================================

-- Homepage announcements/banners/promotions
CREATE TABLE IF NOT EXISTS announcements (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    type ENUM('banner', 'promotion', 'announcement') DEFAULT 'announcement',
    image VARCHAR(255),
    is_active TINYINT(1) DEFAULT 1,
    display_order INT DEFAULT 0,
    created_by INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES admin_users(id) ON DELETE CASCADE,
    INDEX idx_is_active (is_active),
    INDEX idx_type (type),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB;

-- ============================================================
-- PART 8: SECURITY & AUDIT
-- ============================================================

-- User activity logs
CREATE TABLE IF NOT EXISTS user_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_type ENUM('customer', 'admin') NOT NULL,
    user_id INT NOT NULL,
    action VARCHAR(100) NOT NULL,
    details TEXT,
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_type_id (user_type, user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB;

-- Password reset tokens
CREATE TABLE IF NOT EXISTS password_resets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_type ENUM('customer', 'admin') NOT NULL,
    user_id INT NOT NULL,
    token VARCHAR(64) UNIQUE NOT NULL,
    expires_at DATETIME NOT NULL,
    used TINYINT(1) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_token (token),
    INDEX idx_user_type_id (user_type, user_id),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB;

-- Add column to store when customer cleared their view
ALTER TABLE rt_chat_threads 
ADD COLUMN customer_cleared_at DATETIME DEFAULT NULL;

-- Content Management System Pages Table
CREATE TABLE IF NOT EXISTS rt_cms_pages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    page_key VARCHAR(50) NOT NULL,
    page_name VARCHAR(100) NOT NULL,
    content_data JSON NOT NULL,
    status ENUM('draft', 'published') DEFAULT 'draft',
    version INT DEFAULT 1,
    updated_by VARCHAR(100),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_page_key (page_key),
    INDEX idx_status (status),
    INDEX idx_updated (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insert default content for each page
INSERT INTO rt_cms_pages (page_key, page_name, content_data, status, version, updated_by) VALUES
('home', 'Homepage', '{"hero_headline":"<h1>Welcome to RADS Tooling</h1>","hero_subtext":"<p>Your trusted partner in custom cabinets</p>","promo_text":"<p>Quality cabinets at affordable prices!</p>"}', 'published', 1, 'System'),
('about', 'About Us', '{"about_mission":"<p>To provide high-quality custom cabinets</p>","about_vision":"<p>To be the leading cabinet manufacturer in Cavite</p>","about_narrative":"<p>Established in 2007, we have been serving customers for over 17 years</p>","about_address":"Green Breeze, Piela, Dasmariñas, Cavite","about_phone":"+63 976 228 4270","about_email":"radstooling@gmail.com","about_hours_weekday":"Mon-Sat: 8:00 AM - 5:00 PM","about_hours_sunday":"Sunday: Closed"}', 'published', 1, 'System'),
('privacy', 'Privacy Policy', '{"content":"<h2>Privacy Policy</h2><p>Your privacy is important to us...</p>"}', 'published', 1, 'System'),
('terms', 'Terms & Conditions', '{"content":"<h2>Terms & Conditions</h2><p>By using our services...</p>"}', 'published', 1, 'System'),
('global', 'Navigation & Footer', '{"nav_home":"Home","nav_about":"About","nav_products":"Products","global_phone":"+63 976 228 4270","global_email":"radstooling@gmail.com","footer_about":"Premium custom cabinet manufacturer","footer_copyright":"© 2025 RADS TOOLING INC. All rights reserved."}', 'published', 1, 'System');

-- ============================================================
-- DONE - Database schema complete
-- ============================================================